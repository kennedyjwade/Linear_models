---
title: "Bootstrapping"
author: "Kennedy Wade"
date: "2025-11-13"
output: html_document
---

#Bootstrapping 

This is a popular resampling-based approach to statistical inference, and is helpful when usual statistical methods are intractable or inappropriate. The idea is to draw repeated samples from your original sample with replacement, thereby approximating the repeated sampling framework. Using list columns to store bootstrap samples is natural and provides a “tidy” approach to resampling-based inference.



```{r}
library(tidyverse)
library(p8105.datasets)
library(broom)

set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp =.6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme( legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis", 
  ggplot2.continuous.fill = "vidridis"
)

scale_colour_discrete = scale_colour_viridis_d
scacle_fill_discret = scale_fill_viridis_d
```


## simulate 2 datasets ( bootsrapping in SLR)

First I’ll generate x, then an error sampled from a normal distribution, and then a response y; this all gets stored in sim_df_const. Then I’ll modify this by multiplying the errors by a term that involves x, and create a new response variable y.
```{r}
set.seed(1)

n_samp = 250

sim_df_const = 
  tibble(
    x = rnorm(n_samp, 1, 1),
    error = rnorm(n_samp, 0, 1),
    y = 2 + 3 * x + error
  )

sim_df_nonconst = sim_df_const |> 
  mutate(
  error = error * .75 * x,
  y = 2 + 3 * x + error
)

```


Look at this data 
```{r}
sim_df_nonconst |>
  ggplot(aes( x = x, y = y)) +
  geom_point()
```


what does lm do for this data?
```{r}
sim_df_nonconst |>
  lm(y ~ x, data = _) |>
  broom::tidy() |>
  knitr::kable(digits = 3)
```


write a function to draw a bootstrap sample

```{r}
boot_sample = function(df) {
  
  sample_frac(df, size = 1, replace = TRUE)
  
}
```


does this work?
```{r}
sim_df_nonconst |>
  boot_sample() |> 
  ggplot(aes(x = x, y = y)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  xlim(c( -2, 4)) +
  ylim(c( -5, 16))
```


So I want to formulize this a bit and extract results 
```{r}
boot_straps =
  tibble(
    iter = 1:5000
  ) |>
  mutate(
    bootstrap_sample = map(iter, \(i) boot_sample( df = sim_df_nonconst))
  )
```


(quick check)
```{r}
boot_straps |>
  pull(bootstrap_sample) |>
  nth(2) |> 
  ggplot(aes( x = x, y = y)) +
  geom_point( alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
   xlim(c( -2, 4)) +
  ylim(c( -5, 16))
```


Actually run my analyses!
```{r}
bootstrap_results =
  boot_straps |>
  mutate(
    fits = map(bootstrap_sample, \(df) lm(y ~ x, data = df)),
    results = map(fits, broom::tidy)
  )
```


look at results 
```{r}
bootstrap_results |>
  select(iter,results) |>
  unnest(results) |>
  group_by(term) |>
  summarize(
    mean = mean(estimate),
    se   = sd(estimate)
  )
```


look at these first 
```{r}
bootstrap_results |>
  select( iter, results) |>
  unnest(results) |>
  filter(term == "x") |>
  ggplot(aes(x = estimate)) +
  geom_density()
```


```{r}
bootstrap_results |>
  select(iter,results) |>
  unnest(results) |>
  group_by(term) |>
  summarize(
    ci_lower = quantile(estimate, 0.025), 
    ci_upper = quantile(estimate, 0.975))
```

## Do it agaun but faster this time 

```{r}
sim_df_nonconst |>
  modelr::bootstrap(n = 10) |> 
  mutate(
    df = map(strap, as_tibble),
    fits = map(df, \(df) lm(y ~ x, data = df)),
    results = map(fits, broom::tidy)
  ) |>
select(.id,results) |>
  unnest(results)
```


#Airbnb

remember this one?

```{r}
data("nyc_airbnb")

nyc_airbnb = 
  nyc_airbnb |> 
  mutate(stars = review_scores_location / 2) |> 
  rename(
    borough = neighbourhood_group
  ) |>
  filter(
    borough != "Staten Island"
    ) |> 
  drop_na(price, stars, room_type) |> 
  select(price, stars, borough, room_type)
```


remind me what this looks like?
```{r}
nyc_airbnb |>
  ggplot(aes( x = stars, y = price, color = room_type)) +
  geom_point(alpha = .5)
```


try to do bootstrap 
```{r}
airbnb_bootstrap_results =
  nyc_airbnb |>
  filter(borough == "Manhattan") |> 
  modelr::bootstrap(n = 1000) |> 
  mutate(
    df = map(strap, as_tibble),
    fits = map(df, \(df) lm(price ~ stars + room_type, data = df)),
    results = map(fits, broom::tidy)
    ) |> 
  select(.id, results) |> 
  unnest(results) 

```


Look at the distrbuton of the slope for stars 
```{r}
airbnb_bootstrap_results |>
  filter(term =="stars") |>
  ggplot(aes(x = estimate)) +
  geom_density()
```
